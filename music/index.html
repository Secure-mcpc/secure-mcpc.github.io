<!DOCTYPE html><!--deepseekç¼–è¾‘-->
<html>
<body>
<style>
#playlist {
    margin: 10px 0;
    padding: 0;
    list-style: none;
    /*max-height: 200px;*/
    overflow-y: auto;
    height:auto;
}
#playlist li {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #ddd;
    transition: background 0.3s;
}
#playlist li:hover {
    background: #ffffff00;
}
#playlist li.playing {
    background: #e3f2fd;
    font-weight: 500;
}
</style>

<input type="file" id="fileInput" accept="audio/*" multiple style="display: none;">
<button onclick="handleFileSelect()">ğŸ“ æ·»åŠ éŸ³ä¹</button>
<button id="playBtn" disabled>â–¶ æ’­æ”¾</button>
<ul id="playlist"></ul>

<script>
const audio = new Audio();
const playBtn = document.getElementById('playBtn');
const fileInput = document.getElementById('fileInput');
const playlistEl = document.getElementById('playlist');

let userSongs = [];
let currentIndex = -1;
let currentObjectURL = null;
let isSingleLoop = false;

// å¤„ç†æ–‡ä»¶é€‰æ‹©
function handleFileSelect() {
    fileInput.value = ''; // é‡ç½®æ–‡ä»¶é€‰æ‹©å™¨
    fileInput.click();
}

// æ›´æ–°æ’­æ”¾åˆ—è¡¨æ˜¾ç¤º
function updatePlaylist() {
    playlistEl.innerHTML = userSongs.map((file, index) => `
        <li class="${index === currentIndex ? 'playing' : ''}" 
            data-index="${index}"
            onclick="playSpecificSong(${index}, true)">
            ${file.name} (${formatFileSize(file.size)})
        </li>
    `).join('');
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°æ­£åœ¨æ’­æ”¾çš„æ›²ç›®
    const playingItem = playlistEl.querySelector('.playing');
    if (playingItem) {
        playingItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ¸…ç†èµ„æº
function cleanupResources() {
    if (currentObjectURL) {
        URL.revokeObjectURL(currentObjectURL);
        currentObjectURL = null;
    }
    audio.src = '';
}

// æ’­æ”¾æŒ‡å®šæ­Œæ›²
function playSpecificSong(index, loop = false) {
    if (index < 0 || index >= userSongs.length) return;
    
    isSingleLoop = loop;
    currentIndex = index;
    
    cleanupResources();
    const file = userSongs[currentIndex];
    currentObjectURL = URL.createObjectURL(file);
    
    audio.src = currentObjectURL;
    audio.loop = loop;
    audio.play().catch(() => {
        playBtn.textContent = 'â–¶ æ’­æ”¾';
    });
    
    playBtn.disabled = false;
    playBtn.textContent = 'â¸ æš‚åœ';
    updatePlaylist();
}

// æ–‡ä»¶é€‰æ‹©äº‹ä»¶å¤„ç†
fileInput.addEventListener('change', (e) => {
    const newFiles = Array.from(e.target.files);
    if (newFiles.length === 0) return;

    // åˆå¹¶æ–°æ—§æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰
    newFiles.forEach(newFile => {
        if (!userSongs.some(existingFile => 
            existingFile.name === newFile.name && 
            existingFile.size === newFile.size
        )) {
            userSongs.push(newFile);
        }
    });

    // è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€ä¸ªæ–°å¢æ–‡ä»¶ï¼ˆå¦‚æœå½“å‰æ²¡æœ‰åœ¨æ’­æ”¾ï¼‰
    if (currentIndex === -1 && userSongs.length > 0) {
        currentIndex = userSongs.length - newFiles.length;
        playSpecificSong(currentIndex);
    }
    
    updatePlaylist();
    playBtn.disabled = false;
});

// æ’­æ”¾/æš‚åœæ§åˆ¶
playBtn.addEventListener('click', () => {
    if (userSongs.length === 0) return;
    
    if (audio.paused) {
        if (currentIndex === -1) {
            currentIndex = 0;
            playSpecificSong(currentIndex);
        } else {
            audio.play();
        }
        playBtn.textContent = 'â¸ æš‚åœ';
    } else {
        audio.pause();
        playBtn.textContent = 'â–¶ æ’­æ”¾';
    }
});

// æ­Œæ›²ç»“æŸå¤„ç†
audio.addEventListener('ended', () => {
    if (!isSingleLoop) {
        const nextIndex = (currentIndex + 1) % userSongs.length;
        playSpecificSong(nextIndex);
    }
});

// é¡µé¢å…³é—­æ¸…ç†
window.addEventListener('beforeunload', cleanupResources);
</script>
</body>
</html>
